# LeRobot DIP (Digital Image Processing) Setup Guide

This guide explains how to set up and run the LeRobot recording script with Digital Image Processing (DIP) enhancements.

## üìã Prerequisites

- Python 3.10+
- Conda or virtual environment
- SO100 robot hardware (follower and leader arms)
- Cameras connected to the system

---

## ÔøΩ Dataset

The dataset used for this project can be downloaded from Hugging Face:

**Download:** [https://huggingface.co/datasets/sach088/dino_touch_and_go_3_pts](https://huggingface.co/datasets/sach088/dino_touch_and_go_3_pts)

**Visualize:** You can also visualize the dataset online here:
[https://huggingface.co/spaces/lerobot/visualize_dataset?path=%2Fsach088%2Fdino_touch_and_go_3_pts%2Fepisode_0](https://huggingface.co/spaces/lerobot/visualize_dataset?path=%2Fsach088%2Fdino_touch_and_go_3_pts%2Fepisode_0)

---

## ÔøΩüöÄ Installation Steps

### 1. Clone LeRobot Repository

```bash
git clone https://github.com/huggingface/lerobot.git
cd lerobot
```

### 2. Checkout Specific Commit

```bash
git checkout 1d07a4a
```

### 3. Install LeRobot

```bash
pip install -e .
```

Or if you prefer:
```bash
pip install lerobot
```

### 4. Install Additional Dependencies

For Richardson-Lucy deblurring processor:
```bash
pip install scikit-image
```

### 5. Add DIP Files

Copy the DIP folder and script to the LeRobot scripts directory:

```bash
# From your source location, copy:
# - dip/ folder ‚Üí lerobot/src/lerobot/scripts/dip/
# - lerobot_record_dip.py ‚Üí lerobot/src/lerobot/scripts/

# Example:
cp -r /path/to/dip lerobot/src/lerobot/scripts/
cp /path/to/lerobot_record_dip.py lerobot/src/lerobot/scripts/
```

Your directory structure should look like:
```
lerobot/
‚îî‚îÄ‚îÄ src/
    ‚îî‚îÄ‚îÄ lerobot/
        ‚îî‚îÄ‚îÄ scripts/
            ‚îú‚îÄ‚îÄ dip/
            ‚îÇ   ‚îú‚îÄ‚îÄ dim_lighting/
            ‚îÇ   ‚îú‚îÄ‚îÄ shadow_removal/
            ‚îÇ   ‚îî‚îÄ‚îÄ partial_occlusion/
            ‚îî‚îÄ‚îÄ lerobot_record_dip.py
```

### 6. Download Policy Weights

We have uploaded the policy weights to Hugging Face:

```bash
# Using huggingface-cli
huggingface-cli download sach088/dino_touch_and_go_3_pts --local-dir ./policies/dino_touch_and_go_3_pts

# Or manually download from:
# https://huggingface.co/sach088/dino_touch_and_go_3_pts
```

---

## üéÆ Running the Script

### Basic Command

Navigate to the scripts directory:
```bash
cd lerobot/src/lerobot/scripts
```

Run the recording script with DIP:

```bash
python lerobot_record_dip.py \
  --robot.type=so100_follower \
  --robot.port=/dev/ttyFollower \
  --robot.id=my_awesome_follower_arm \
  --display_data=false \
  --dataset.single_task="Touch the dino" \
  --policy.path=./policies/dino_touch_and_go_3_pts \
  --teleop.type=so100_leader \
  --teleop.port=/dev/ttyLeader \
  --teleop.id=my_awesome_leader_arm \
  --dataset.episode_time_s=20 \
  --dataset.reset_time_s=5 \
  --dataset.repo_id=sach088/eval_topple_the_dino_returns_again_145K \
  --robot.cameras="{front: {type: opencv, index_or_path: /dev/video6, width: 640, height: 480, fps: 30}, side: {type: opencv, index_or_path: '/dev/video0', width: 640, height: 480, fps: 30}}" \
  --dip.method=clahe \
  --policy.n_action_steps=100
```

---

## üé® DIP Method Options

Replace `--dip.method=clahe` with one of the following:

### 1. **CLAHE Enhancement** (Dim Lighting)
```bash
--dip.method=clahe \
--dip.camera_suffix=_dim
```
- Best for: Low-light conditions
- Requires: `clahe_params.json` (generated by training script)

### 2. **Gamma Enhancement** (Dim Lighting)
```bash
--dip.method=gamma_enhancement \
--dip.camera_suffix=_dim
```
- Best for: Quick brightness adjustment
- Requires: `gamma_params.json` (generated by training script)

### 3. **Shadow Removal** (Adaptive Illumination)
```bash
--dip.method=shadow_removal \
--dip.camera_suffix=_shadow
```
- Best for: Removing shadows from images
- Learns parameters automatically from reference images

### 4. **SSR Enhancement** (Shadow Removal)
```bash
--dip.method=ssr_enhancement \
--dip.camera_suffix=_shadow
```
- Best for: Fast shadow removal
- Uses fixed parameters (no training needed)

### 5. **Wiener Deblurring**
```bash
--dip.method=wiener_deblur \
--dip.camera_suffix=_blurred
```
- Best for: Fast deblurring
- Uses fixed parameters (no training needed)

### 6. **Richardson-Lucy Deblurring**
```bash
--dip.method=richardson_lucy_deblur \
--dip.camera_suffix=_blurred
```
- Best for: High-quality deblurring
- Requires: `scikit-image` installed
- Slower but better quality

### 7. **Combined Processing**
```bash
--dip.method=both \
--dip.camera_suffix=_dim
```
- Applies: CLAHE + Shadow Removal

### 8. **No Processing**
```bash
--dip.method=none
```
- Disables all DIP processors

---

## üìù Complete Example Commands

### Example 1: Recording with CLAHE Enhancement
```bash
python lerobot_record_dip.py \
  --robot.type=so100_follower \
  --robot.port=/dev/ttyFollower \
  --robot.id=my_awesome_follower_arm \
  --display_data=false \
  --dataset.single_task="Touch the dino" \
  --policy.path=./policies/dino_touch_and_go_3_pts \
  --teleop.type=so100_leader \
  --teleop.port=/dev/ttyLeader \
  --teleop.id=my_awesome_leader_arm \
  --dataset.episode_time_s=20 \
  --dataset.reset_time_s=5 \
  --dataset.repo_id=sach088/eval_topple_the_dino_returns_again_145K \
  --robot.cameras="{front: {type: opencv, index_or_path: /dev/video6, width: 640, height: 480, fps: 30}, side: {type: opencv, index_or_path: '/dev/video0', width: 640, height: 480, fps: 30}}" \
  --dip.method=clahe \
  --dip.camera_suffix=_dim \
  --policy.n_action_steps=100
```

### Example 2: Recording with Wiener Deblurring
```bash
python lerobot_record_dip.py \
  --robot.type=so100_follower \
  --robot.port=/dev/ttyFollower \
  --robot.id=my_awesome_follower_arm \
  --display_data=false \
  --dataset.single_task="Touch the dino" \
  --policy.path=./policies/dino_touch_and_go_3_pts \
  --teleop.type=so100_leader \
  --teleop.port=/dev/ttyLeader \
  --teleop.id=my_awesome_leader_arm \
  --dataset.episode_time_s=20 \
  --dataset.reset_time_s=5 \
  --dataset.repo_id=sach088/eval_topple_the_dino_returns_again_145K \
  --robot.cameras="{front: {type: opencv, index_or_path: /dev/video6, width: 640, height: 480, fps: 30}, side: {type: opencv, index_or_path: '/dev/video0', width: 640, height: 480, fps: 30}}" \
  --dip.method=wiener_deblur \
  --policy.n_action_steps=100
```

### Example 3: Recording with No DIP Processing
```bash
python lerobot_record_dip.py \
  --robot.type=so100_follower \
  --robot.port=/dev/ttyFollower \
  --robot.id=my_awesome_follower_arm \
  --display_data=false \
  --dataset.single_task="Touch the dino" \
  --policy.path=./policies/dino_touch_and_go_3_pts \
  --teleop.type=so100_leader \
  --teleop.port=/dev/ttyLeader \
  --teleop.id=my_awesome_leader_arm \
  --dataset.episode_time_s=20 \
  --dataset.reset_time_s=5 \
  --dataset.repo_id=sach088/eval_topple_the_dino_returns_again_145K \
  --robot.cameras="{front: {type: opencv, index_or_path: /dev/video6, width: 640, height: 480, fps: 30}, side: {type: opencv, index_or_path: '/dev/video0', width: 640, height: 480, fps: 30}}" \
  --dip.method=none \
  --policy.n_action_steps=100
```

---

## üîß Configuration Parameters

### Robot Configuration
- `--robot.type`: Robot type (e.g., `so100_follower`)
- `--robot.port`: Serial port for follower arm (e.g., `/dev/ttyFollower`)
- `--robot.id`: Identifier for the robot
- `--robot.cameras`: Camera configuration (JSON format)

### Teleoperator Configuration
- `--teleop.type`: Teleoperator type (e.g., `so100_leader`)
- `--teleop.port`: Serial port for leader arm (e.g., `/dev/ttyLeader`)
- `--teleop.id`: Identifier for the teleoperator

### Dataset Configuration
- `--dataset.repo_id`: Hugging Face dataset repository ID
- `--dataset.single_task`: Task description
- `--dataset.episode_time_s`: Recording time per episode (seconds)
- `--dataset.reset_time_s`: Reset time between episodes (seconds)

### Policy Configuration
- `--policy.path`: Path to policy weights folder
- `--policy.n_action_steps`: Number of action steps (default: 100)

### DIP Configuration
- `--dip.method`: DIP method to use (see options above)
- `--dip.camera_suffix`: Camera suffix for filtering (optional)
- `--dip.clahe_params_file`: Custom CLAHE parameters file (optional)
- `--dip.gamma_params_file`: Custom gamma parameters file (optional)

### Display Configuration
- `--display_data`: Show visualization (true/false)

---

## üìä Camera Suffix Guide

The `--dip.camera_suffix` parameter is **optional** and controls which cameras get processed:

### Without Suffix (Process All Cameras)
```bash
--dip.method=clahe
# Processes all cameras
```

### With Suffix (Process Specific Cameras)
```bash
--dip.method=clahe \
--dip.camera_suffix=_dim
# Only processes cameras ending with "_dim" (e.g., front_dim, side_dim)
```

**Common Suffixes:**
- `_dim` - For dim/low-light cameras (CLAHE, Gamma)
- `_shadow` - For cameras with shadows (Shadow Removal, SSR)
- `_blurred` - For blurred cameras (Wiener, Richardson-Lucy)

---
